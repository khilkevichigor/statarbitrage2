package com.example.core.messaging;

import com.example.core.handlers.NewCointPairsEventHandler;
import com.example.shared.events.rabbit.CointegrationEvent;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.stereotype.Service;

import java.util.function.Consumer;

/**
 * –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class ReceiveEventService {
    private final NewCointPairsEventHandler newCointPairsEventHandler;

    /**
     * –í—ã—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ø–∏–∫ –ö–æ–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
     */
    @Bean
    public Consumer<CointegrationEvent> cointegrationEventsConsumer() {
        return this::handleEvent;
    }

    //===–ö–ï–ô–° –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è BERA/NMR===

    /*
    –ü–ï–†–ï–°–ï–ß–ï–ù–ò–ï –ì–†–ê–§–ò–ö–û–í
    —É –º–µ–Ω—è –µ—Å—Ç—å —Å–µ—Ä–≤–∏—Å –∫–æ—Ç–æ—Ä—ã–π —Å—á–∏—Ç–∞–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –≤ —Ç–æ—á–∫–∞—Ö –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
    –ø–∏–∫—Å–µ–ª–∏: com.example.core.experemental.intersections.AnalyzeChartIntersectionsService.analyze
    —Ç–æ—á–∫–∏:   com.example.core.services.PriceIntersectionService.calculateIntersectionsWithChart

    —á–∞—Ä—Ç—ã —Å —Ç–æ—á–∫–∞–º–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ /Users/igorkhilkevich/IdeaProjects/statarbitrage/microservices/charts/filter/intersections —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä –æ—Ç Cointegration
    —á–∞—Ä—Ç—ã —Å –ø–∏–∫—Å–µ–ª—è–º–∏ –≥–µ–Ω–µ—Ä—è—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ. –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –ü–æ—Å—Ç–º–∞–Ω

    —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è —á—Ç–æ –≤—ã–±—Ä–∞—Ç—å, —Ç–æ—á–∫–∏ –≤—Ä–æ–¥–µ –Ω–æ—Ä–º!
    –Ω—É–∂–Ω–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–∞—Ä—ã —Å–ª–∞—Ç—å –≤ —Ç–µ–ª–µ–≥—É —á–∞—Ä—Ç —Å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è–º–∏ —á—Ç–æ –±—ã —Ç—Ä–µ–∫–∞—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

     */

    //todo –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –æ—Ç–±–æ—Ä –ø–∞—Ä –∏–∑ —Ç–æ–ø-N –ø–æ coinmarketcap
    //todo —Å–¥–µ–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á—Ç–æ –ø—Ä–æ—Å–∞–¥–∫–∞ >10, >20, >30 - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ —Å—Ç–∞–≤–∏–º –Ω–∞ –∫–∞—Ä–∞–Ω–¥–∞—à –∏ —á–µ–∫–∞–µ–º –ª–∏–∫–≤–∏–¥–∞—Ü–∏—é
    //todo —á–µ–∫–µ—Ä —á—Ç–æ –ø–æ–∑–∏—Ü–∏—é –ª–∏–∫–≤–∏–¥–Ω—É–ª–æ
    //todo –ø–æ—Å–ª–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ BERA-NMR –º–æ–∂–µ—Ç –µ—Å—Ç—å —Å–º—ã—Å–ª —Ç–æ—Ä–≥–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä—ã –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏—è —Ç–∞–∫–æ–≥–æ —Ç—Ä–µ—à–∞–∫–∞
    //todo –∫–∞–∫ —Ç–æ —á–µ–∫–∞—Ç—å —á–∞—Ä—Ç –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ü–µ–Ω - —á—Ç–æ —Ü–µ–Ω—ã –ø–µ—Ä–µ–ø–ª–µ—Ç–∞—é—Ç—Å—è (–º–æ–∂–µ—Ç —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≥—É - –∫–∏–¥–∞—Ç—å —á–∞—Ä—Ç –∏ –∫–Ω–æ–ø–∫—É "go")
    //todo —Å–¥–µ–ª–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–∞—Ä, –º–æ–∂–µ—Ç —á–µ—Ä–µ–∑ –±–¥, —á—Ç–æ –±—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ –ø–∞—Ä–∞ –Ω–µ –æ—Ç–±–∏—Ä–∞–ª–∞—Å—å
    //todo –µ—Å–ª–∏ –ª–∏–∫–≤–∏–¥–Ω—É–ª–æ 1 –º–æ–Ω–µ—Ç—É –∏–∑ –ø–∞—Ä—ã - —Å–¥–µ–ª–∞—Ç—å —Å–∏–Ω–∫ —á—Ç–æ–±—ã —è –ø–æ–Ω–∏–º–∞–ª —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏ —á—Ç–æ –æ–¥–Ω–∞ –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã–ª–∞—Å—å! –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∏–ª–∏ –æ—Ä–¥–µ—Ä–æ–≤ —á–µ–∫–∞—Ç—å "–õ–∏–∫–≤–∏–¥–∞—Ü–∏—è –∫—É–ø–∏—Ç—å"
    //todo –Ω–∞ UI —Å–¥–µ–ª–∞—Ç—å –≤–≤–æ–¥ notes - —á—Ç–æ –±—ã —Ç—É–¥–∞ —è –º–æ–≥ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç—ã –ø–æ –ø–∞—Ä–µ - –Ω–∞–ø—Ä–∏–º–µ—Ä "–ª–∏–∫–≤–∏–¥–Ω—É–ª–æ –ê, –ë –∑–∞–∫—Ä—ã–ª –ø–æ –∫–Ω–æ–ø–∫–µ"
    //===–ö–ï–ô–° –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è BERA/NMR===

    // !!! todo —Å–¥–µ–ª–∞—Ç—å —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ "Max –ø—Ä–æ—Å–∞–¥–∫–∞" –∏ "–í—Ä–µ–º—è –¥–æ Max –ø—Ä–æ—Å–∞–¥–∫–∏" —á—Ç–æ –±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—ã –∏ –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–Ω–∞–ª–∏–∑–∞ - —Å–∫–æ–ª—å–∫–æ –≤ —Å—Ä–µ–¥–Ω–µ–º —É –Ω–∞—Å –ø—Ä–æ—Å–∞–¥–∫–∞ –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º, –∫–∞–∫–∞—è –æ–Ω–∞, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç–æ—Ä–≥—É–µ—Ç—Å—è –ø–∞—Ä–∞, –∏ —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å –∫–∞–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å
    // !! todo –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–¥–µ–ª–∞—Ç—å —á–µ–∫–±–æ–∫—Å - "–∞–≤—Ç–æ–æ–±—ä–µ–º" –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –±—É–¥–µ–º –±—Ä–∞—Ç—å 1/11 –æ—Ç –¥–µ–ø–æ –Ω–∞ –ø–∞–ø—É, –ø–æ—Å–ª–µ–¥–Ω—è—è 11-–∞—è —á–∞—Å—Ç—å –∏–¥–µ—Ç –Ω–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ—Å–∞–¥–∫–∞—Ö

    //todo —Å–¥–µ–ª–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∞–≤—Ç–æ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–π —Ä–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±–∞–ª–∞–Ω—Å–∞! –ë–∞–ª–∞–Ω—Å —Ä–∞—Å—Ç–µ—Ç - –æ–±—ä–µ–º –ø–æ–∑–∏—Ü–∏–∏ –±–æ–ª—å—à–µ! –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—É—Ç–µ–º –≤–∑—è—Ç–∏—è % –æ—Ç –¥–µ–ø–æ! –ù–∞–ø—Ä–∏–º–µ—Ä –¥–µ–ª–∏—Ç—å –¥–µ–ø–æ –Ω–∞ 11 —á–∞—Å—Ç–µ–π! 10 –≤ –ø–∞—Ä—ã, 1 —á–∞—Å—Ç—å –Ω–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è! –ò —Ç–∞–∫ –∫–∞–∂–¥—ã–π —Ä–∞–∑!

    //todo —Å–¥–µ–ª–∞—Ç—å –∫–Ω–æ–ø–∫—É "–¢–æ—Ä–≥–æ–≤–∞—Ç—å" –¥–ª—è –Ω–∞–±–ª—é–¥–∞–µ–º—ã—Ö –ø–∞—Ä - –Ω–∞–ø—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ BTC-ETH –≤ —Ç–æ—Ä–≥–æ–≤–ª—é! –ò–ª–∏ –∂–µ —Å–¥–µ–ª–∞—Ç—å —Ç–µ—Ö—Ç–ê—Ä–µ–∞ –¥–ª—è –û—Ç–æ–±—Ä–∞–Ω–Ω—ã–µ –ø–∞—Ä—ã –ø–æ
    // –∞–Ω–∞–ª–æ–≥–∏–∏ —Å –ù–∞–±–ª—é–¥–∞–µ–º—ã–º–∏! –ò–ª–∏ –∂–µ —Å–¥–µ–ª–∞—Ç—å —Ç–µ—Ö—Ç–ê—Ä–µ–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —á—Ç–æ –±—ã —É–∫–∞–∑—ã–≤–∞—Ç—å –ø–∞—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—Å–µ–≥–¥–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª—é.

    //todo —Å–¥–µ–ª–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

    //todo –±—Ä–∞—Ç—å –æ–∫—Ö –¥—Ç–æ –ø–æ–∑–∏—Ü–∏–∏ –∏ —Ö—Ä–∞–Ω–∏—Ç—å –µ–µ –∫–∞–∫ –µ—Å—Ç—å —É —Å–µ–±—è –≤ –±–¥ –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —á–∏—Å—Ç–æ —Å –Ω–µ–π –∞ –Ω–µ —Å —Ç–µ–∫—É—â–µ–π Position

    //todo —Å–¥–µ–ª–∞—Ç—å —Å—á–µ—Ç—á–∏–∫ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π –¥–ª—è TradingPairs - —Ç—É–ø–æ –ø–æ–ª–µ =0 –∏ –ø–æ—Ç–æ–º –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ç—å –µ–≥–æ

    //todo —Å–¥–µ–ª–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–∞ UI –∫–æ–ª–æ–Ω–∫–∏ long/short allocatedAmount –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–Ω–µ—Ç—ã

    //todo —Å–¥–µ–ª–∞—Ç—å —Ö–∞—Ä–¥ —Å—Ç–æ–ø –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º –∏–Ω–∞—á–µ –∑–∞ –Ω–æ—á—å –º–æ–∂–Ω–æ –≤–ª–∏—Ç—å –≤–µ—Å—å –¥–µ–ø–æ –≤ —Å–¥–µ–ª–∫–∏ –ø–æ –∫–∞–∫–æ–π —Ç–æ –ø—Ä–∏—á–∏–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤—Ç–æ—Ä–æ–π –º–æ–Ω–µ—Ç—ã –∏–Ω–µ—Ç –æ—Ç–≤–µ–ª–∏–ª—Å—è –Ω–∞ 1–º–∏–Ω –∏ –ø–æ—Ç–æ–º –ø–æ—è–≤–∏–ª—Å—è) - –Ω—É–∂–Ω–æ —Å—Ç–æ–ø–∞—Ç—å –≤—Å–µ –∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –∏ –ø–æ—Ç–æ–º —Ä–∞–∑–±–∏—Ä–∞—Ç—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç

    // + todo —Å–¥–µ–ª–∞—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞–ø–≥—Ä–µ–π–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è - —Å–¥–µ–ª–∞—Ç—å —à–∞–≥ –¥–ª—è –ø—Ä–æ—Å–∞–¥–∫–∏ - —É—Å—Ä–µ–¥–Ω—è–µ–º—Å—è –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - –ø—Ä–∏ -10%, –≤—Ç–æ—Ä–æ–π - –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç(-10%) * —à–∞–≥ 1.5, —Ç—Ä–µ—Ç–∏–π - –ø–æ—Å–ª–µ–¥–Ω–∏–π(-15%) * —à–∞–≥ 1.5, –∏ —Ç–¥

    private void handleEvent(CointegrationEvent event) {
        log.info("");
        log.info("üìÑ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: {}", event.getEventType());
        event.getCointPairs().forEach(v -> log.info("{} z={}", v.getPairName(), v.getZScoreCurrent()));
        try {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
            switch (event.getType()) {
                case NEW_COINT_PAIRS:
                    newCointPairsEventHandler.handle(event);
                    break;
                default:
                    log.warn("‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è: {}", event.getEventType());
            }
        } catch (Exception e) {
            log.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è: {}", e.getMessage(), e);
        }
    }
}